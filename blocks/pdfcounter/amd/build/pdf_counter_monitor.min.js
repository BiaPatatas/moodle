define("block_pdfcounter/pdf_counter_monitor",["jquery"],(function($){var PdfCounterMonitor={courseid:null,refreshInterval:3e3,intervalId:null,initialized:!1,init:function(courseid){this.courseid=this.getCurrentCourseId(courseid),!this.courseid||this.courseid<=0||(this.startMonitoring(),this.setupDOMObserver(),this.initialized=!0)},getCurrentCourseId:function(providedCourseId){if(providedCourseId&&providedCourseId>0)return providedCourseId;var courseIdFromUrl=new URLSearchParams(window.location.search).get("id");if(courseIdFromUrl&&parseInt(courseIdFromUrl)>0)return parseInt(courseIdFromUrl);var bodyElement=document.querySelector("body");if(bodyElement){var courseIdFromBody=bodyElement.getAttribute("data-courseid")||bodyElement.getAttribute("data-course-id");if(courseIdFromBody&&parseInt(courseIdFromBody)>0)return parseInt(courseIdFromBody)}var pageWrapper=document.querySelector("#page-wrapper");if(pageWrapper){var courseIdFromWrapper=pageWrapper.getAttribute("data-courseid");if(courseIdFromWrapper&&parseInt(courseIdFromWrapper)>0)return parseInt(courseIdFromWrapper)}var courseHeader=document.querySelector(".course-content");if(courseHeader){var courseIdFromHeader=courseHeader.getAttribute("data-courseid");if(courseIdFromHeader&&parseInt(courseIdFromHeader)>0)return parseInt(courseIdFromHeader)}return M.cfg&&M.cfg.courseid&&M.cfg.courseid>0?M.cfg.courseid:window.location.pathname.match(/\/course\/view\.php/)&&courseIdFromUrl?parseInt(courseIdFromUrl):null},startMonitoring:function(){this.evaluatePendingPdfs()},stopMonitoring:function(){},evaluatePendingPdfs:function(){var self=this;!function evalNext(){$.ajax({url:M.cfg.wwwroot+"/blocks/pdfcounter/ajax_eval_pdf.php",type:"POST",dataType:"json",contentType:"application/x-www-form-urlencoded",data:$.param({courseid:self.courseid,sesskey:M.cfg.sesskey}),success:function(response){response.done?setTimeout((function(){self.refreshDashboard(),setTimeout(self.evaluatePendingPdfs.bind(self),self.refreshInterval)}),500):setTimeout((function(){self.refreshDashboard(),setTimeout(evalNext,1e3)}),500)},error:function(){setTimeout(evalNext,self.refreshInterval)}})}()},refreshDashboard:function(){var self=this;$.ajax({url:M.cfg.wwwroot+"/blocks/pdfcounter/ajax/update_dashboard.php",type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify({courseid:self.courseid,sesskey:M.cfg.sesskey}),success:function(response){"ok"===response.status&&self.updateDashboardUI(response)}})},updateDashboardUI:function(data){var pendingCount=0;data.pdfIssues&&data.pdfIssues.length>0&&data.pdfIssues.forEach((function(issue){var totalTests=issue.pass_count+issue.fail_count+issue.not_tagged_count,doneTests=issue.pass_count+issue.fail_count+issue.not_tagged_count;totalTests>0&&doneTests===issue.not_tagged_count&&pendingCount++}));var pendingMsg=document.getElementById("pdf-pending-msg");pendingMsg&&(pendingCount>0?(pendingMsg.innerHTML="⚠️ Ainda faltam "+pendingCount+" PDF(s) para avaliar nesta página.",pendingMsg.style.display=""):(pendingMsg.innerHTML="",pendingMsg.style.display="none"));try{$.ajax({url:M.cfg.wwwroot+"/blocks/pdfcounter/ajax/log_pdf_issues.php",type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify({pdfIssues:data.pdfIssues,courseid:data.courseid||(window.M&&M.cfg&&M.cfg.courseid?M.cfg.courseid:null)})})}catch(e){}var overallElement=$("#overall-accessibility-value");if(overallElement.length){overallElement.text(data.overallProgress+"%");overallElement.css("color","#000000ff")}var progressBar=$(".pdf-counter-progress-bar");if(progressBar.length){progressBar.attr("value",data.overallProgress);var progressColor=data.overallProgress>=80?"#28a745":data.overallProgress>=50?"#ffc107":"#dc3545";progressBar.css("--progress-color",progressColor)}this.updatePdfIssues(data.pdfIssues),this.updateHistoricalChart(data.overallProgress);var totalElement=$(".total-pdfs-count");totalElement.length&&totalElement.text(data.totalPdfs+" PDFs")},updatePdfIssues:function(pdfIssues){var issuesList=$("#pdf-issues-list tbody");if(issuesList.length)if(pdfIssues&&0!==pdfIssues.length){pdfIssues.sort((function(a,b){var applicableA=(a.pass_count||0)+(a.fail_count||0)+(a.not_tagged_count||0),applicableB=(b.pass_count||0)+(b.fail_count||0)+(b.not_tagged_count||0),failedA=(a.fail_count||0)+(a.not_tagged_count||0),failedB=(b.fail_count||0)+(b.not_tagged_count||0),ratioA=applicableA>0?failedA/applicableA:0,ratioB=applicableB>0?failedB/applicableB:0;return ratioB===ratioA?failedB-failedA:ratioB-ratioA}));var html="",self=this;pdfIssues.forEach((function(pdf){var applicableTests=pdf.pass_count+pdf.fail_count+pdf.not_tagged_count,failedTests=pdf.fail_count+pdf.not_tagged_count,downloadUrl=M.cfg.wwwroot+"/blocks/pdfcounter/download_report.php?filename="+encodeURIComponent(pdf.filename)+"&courseid="+self.courseid;html+='<tr><td colspan="1" style="padding:0;">',html+='<div class="parent" style="display:grid; grid-template-columns:1fr; grid-template-rows:repeat(3,1fr); grid-column-gap:0; grid-row-gap:0;">',html+='<div class="div1" style="grid-area:1/1/2/2; align-self:start; font-size:1em;">'+pdf.filename+"</div>",html+='<div class="div2" style="grid-area:2/1/3/2; align-self:start; text-align:left; font-weight:bold; font-size:1.1em;">'+failedTests+" of "+applicableTests+" tests failed</div>",html+='<div class="div3" style="grid-area:3/1/4/2; text-align:right;">',html+='<a href="'+downloadUrl+'" target="_blank" style="color:#1976d2; text-decoration:underline; font-size:0.95em; display:inline-flex; align-items:center; gap:4px;">',html+='<i class="fa fa-download" aria-hidden="true" style="color:#1976d2;"></i> Download Report',html+="</a>",html+="</div>",html+="</div>",html+="</td></tr>"})),issuesList.html(html)}else issuesList.html('<tr><td colspan="2" style="text-align: center; color: #28a745; font-style: italic; padding: 15px;">No PDF accessibility issues found.</td></tr>')},updateHistoricalChart:function(currentProgress){if("undefined"!=typeof Chart&&window.progressChart){var currentMonth=(new Date).toISOString().slice(0,7),chart=window.progressChart,labels=chart.data.labels,data=chart.data.datasets[0].data,monthIndex=labels.indexOf(currentMonth);-1!==monthIndex?data[monthIndex]=currentProgress:(labels.push(currentMonth),data.push(currentProgress),labels.length>6&&(labels.shift(),data.shift())),chart.update()}},setupDOMObserver:function(){var self=this,targetNode=document.querySelector("#region-main");targetNode&&new MutationObserver((function(mutations){var shouldRefresh=!1;mutations.forEach((function(mutation){"childList"===mutation.type&&(mutation.addedNodes.forEach((function(node){node.nodeType===Node.ELEMENT_NODE&&(node.classList.contains("activity")||node.querySelector(".activity")||node.classList.contains("resource")||node.querySelector(".resource")||node.classList.contains("activityinstance")||node.querySelector(".activityinstance"))&&(shouldRefresh=!0)})),mutation.removedNodes.forEach((function(node){node.nodeType===Node.ELEMENT_NODE&&(node.classList.contains("activity")||node.querySelector(".activity")||node.classList.contains("resource")||node.querySelector(".resource")||node.classList.contains("activityinstance")||node.querySelector(".activityinstance"))&&(shouldRefresh=!0)})))})),shouldRefresh&&setTimeout((function(){self.refreshDashboard()}),2e3)})).observe(targetNode,{childList:!0,subtree:!0})},destroy:function(){this.stopMonitoring(),this.initialized=!1}};return{init:function(courseid){PdfCounterMonitor.init(courseid)},destroy:function(){PdfCounterMonitor.destroy()}}}));

//# sourceMappingURL=pdf_counter_monitor.min.js.map