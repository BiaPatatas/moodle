{"version":3,"file":"pdf_analyzer.min.js","sources":["../src/pdf_analyzer.js"],"sourcesContent":["define([], function() {\n    return {\n        init: function() {\n            const getDraftId = () => document.getElementById('id_files')?.value;\n            const sesskey = M.cfg.sesskey; // Moodle disponibiliza isto globalmente\n            const filemanagerList = document.querySelector('.filemanager .fp-content');\n\n            if (!filemanagerList) {\n                console.warn('filemanager não encontrado!');\n                return;\n            }\n\n            // Function to get current course ID\n            const getCurrentCourseId = function() {\n                // Try URL parameter first\n                var urlParams = new URLSearchParams(window.location.search);\n                var courseIdFromUrl = urlParams.get('id');\n                if (courseIdFromUrl && parseInt(courseIdFromUrl) > 0) {\n                    return parseInt(courseIdFromUrl);\n                }\n\n                // Try body data attributes\n                var bodyElement = document.body;\n                if (bodyElement) {\n                    var courseIdFromBody = bodyElement.getAttribute('data-courseid') ||\n                                          bodyElement.getAttribute('data-course-id');\n                    if (courseIdFromBody && parseInt(courseIdFromBody) > 0) {\n                        return parseInt(courseIdFromBody);\n                    }\n                }\n\n                // Try Moodle config\n                if (typeof M !== 'undefined' && M.cfg && M.cfg.courseId && parseInt(M.cfg.courseId) > 0) {\n                    return parseInt(M.cfg.courseId);\n                }\n\n                // Fallback - try to find course ID in page elements\n                var courseLink = document.querySelector('a[href*=\"course/view.php?id=\"]');\n                if (courseLink) {\n                    var match = courseLink.href.match(/[?&]id=(\\d+)/);\n                    if (match && parseInt(match[1]) > 0) {\n                        return parseInt(match[1]);\n                    }\n                }\n\n                return null;\n            };\n\n            const fetchPdfInfo = (draftid) => {\n                const courseid = getCurrentCourseId();\n                fetch('/blocks/pdfaccessibility/ajax/preview.php', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json',\n                        'X-Requested-With': 'XMLHttpRequest'\n                    },\n                    body: JSON.stringify({draftid, sesskey, courseid})\n                })\n                .then(res => res.json())\n                .then(data => {\n                    const div = document.getElementById('analyzer-result');\n                    if (!div) {\n                        return null;\n                    }\n                    if (data.status !== 'ok' || !data.pdfs || !Array.isArray(data.pdfs) || data.pdfs.length === 0) {\n                        div.innerHTML = `<span style=\"color:red\">${data.message || 'Erro ao analisar PDF.'}</span>`;\n                        return null;\n                    }\n\n                    const testConfig = data.testConfig || [];\n                    // Function to determine check value (matches PHP pdf_accessibility_config::determine_js_check_value)\n                    const determineCheckValue = (testKey, testValue) => {\n                        if (testValue === true) {\n return 'Pass';\n}\n                        if (testValue === 'PDF not tagged') {\n return 'PDF not tagged';\n}\n                        if (testValue === 'Non applicable') {\n return 'Non applicable';\n}\n                        if (testValue === false) {\n return 'Fail';\n}\n                        // Special cases\n                        if (testKey === 'Title' && testValue === 'No Title Found') {\n return 'Fail';\n}\n                        if (testKey === 'Title' && testValue !== 'No Title Found') {\n return 'Pass';\n}\n                        if (testKey === 'Languages match') {\n return testValue ? 'Pass' : 'Fail';\n}\n                        if (testKey === 'PDF only image') {\n return testValue === 'PDF with text' ? 'Pass' : 'Fail';\n}\n                        return testValue; // Return as-is for other cases\n                    };\n\n                    let html = '';\n                    data.pdfs.forEach((pdf, idx) => {\n                        const filename = pdf.filename || `PDF ${idx + 1}`;\n                        const summary = pdf.summary;\n                        if (!summary) {\n return;\n}\n                        // Garante alinhamento correto entre key, label, descrição e valor, e oculta testes indesejados\n                        const excludedKeys = ['Language declared', 'Language detected'];\n                        const checks = Object.keys(summary)\n                            .filter(key => !excludedKeys.includes(key))\n                            .map((key) => {\n                                const config = testConfig.find(cfg => cfg.key === key) || {};\n                                const value = determineCheckValue(key, summary[key]);\n                                return {\n                                    key: key,\n                                    label: config.label || key,\n                                    value: value,\n                                    pass: value === 'Pass',\n                                    raw: summary[key],\n                                    link: config.link || '',\n                                    linkText: config.linkText || 'How to fix?',\n                                    description: config.description || ''\n                                };\n                            });\n                        const passed = checks.filter(c => c.pass).length;\n                        const nonApplicable = checks.filter(c => c.value === \"Non applicable\").length;\n                        // Const pdfNotTagged = checks.filter(c => c.value === \"PDF not tagged\").length; // removido pois não é usado\n                        const failed = checks.length - passed - nonApplicable;\n                        // Custom sort: Pass -> Fail -> PDF not tagged -> Non applicable\n                        checks.sort((a, b) => {\n                            // Define priority order\n                            const getPriority = (check) => {\n                                if (check.pass) {\n return 1;\n} // Pass first\n                                if (check.value === \"Fail\") {\n return 2;\n} // Fail second\n                                if (check.value === \"PDF not tagged\") {\n return 3;\n} // PDF not tagged third\n                                if (check.value === \"Non applicable\") {\n return 4;\n} // Non applicable last\n                                return 5; // Any other case\n                            };\n                            return getPriority(a) - getPriority(b);\n                        });\n                        html += `\n        <div style=\"font-family:Arial,sans-serif;max-width:320px;\">\n            <div style=\"background: #f8f9fa; border-radius: 8px; padding: 15px; background-color: white; \n            border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); color: black; margin-bottom: 10px;\">\n                <i class=\"fas fa-universal-access\" aria-hidden=\"true\"></i>\n                <bold style=\"font-size: 0.95rem; font-weight: bold; margin-bottom: 2px;\">${filename}</bold><br>\n                <div style=\"margin-top:10px\">\n                    <span style=\"color:#27ae60;font-weight:bold;\">${passed}</span>\n                    <span style=\"color:black;\">passed</span>\n                    <span style=\"color:#e74c3c;font-weight:bold;margin-left:10px;\">${failed}</span>\n                    <span style=\"color:black;\">failed</span>\n                </div>\n            </div>\n            <div>\n            <div style=\"background: #f8f9fa;\n                        border-radius: 8px;\n                        padding: 10px;\n                        background-color: white;\n                        border-radius: 8px;\n                        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\n                        color: black;\n                        margin-bottom: 10px;\">\n                             \n                    <bold style=\"   font-size: 0.90rem;\n                                    font-weight: bold;\n                                    margin-bottom: 2px;\">Detailed Report</bold><br>\n                    ${checks.map((c, i) => {\n                        let bg = c.pass ? '#eafaf1' : '#fff4f4';\n                        let icon = c.pass\n    ? '<i style=\"color:green;\" class=\"fa fa-check\" aria-hidden=\"true\"></i>'\n    : '<i style=\"color:red;\" class=\"fa fa-times\" aria-hidden=\"true\"></i>';\n                        let color = c.pass ? '#27ae60' : '#e74c3c';\n                        let opacity = 1;\n                        let extra = '';\n                        // Info icon and description\n                        let infoId = `desc_${c.key.replace(/\\s+/g, '_')}_${i}_${idx}`;\n                        let infoIcon = `<span class=\\\"pdf-info-icon\\\" style=\\\"cursor:pointer; color:#1976d2; margin-left:6px;\\\" data-info-id=\\\"${infoId}\\\"><i class='fa fa-info-circle' style=\"color: #252525ff;\"></i></span>`;\n                        let infoDesc = '';\n                        if (c.description) {\n                            infoDesc = `<div id=\\\"${infoId}\\\" class=\\\"pdf-info-desc\\\" style=\\\"display:none; background:#f8f9fa; border:1px solid #e3e3e3; border-radius:6px; margin:6px 0 8px 0; padding:8px; font-size:0.92em; color:#333;\\\">${c.description}</div>`;\n                        }\n                        if (c.value === 'Non applicable') {\n                            bg = '#f3f3f3';\n                            color = '#000000ff';\n                            opacity = 0.6;\n                            icon = '<i style=\"color:#000000;\" class=\"fa fa-minus-circle\" aria-hidden=\"true\"></i>';\n                        }\n                        if (c.value === 'PDF not tagged') {\n                            bg = '#fffbe6';\n                            color = '#e6b800';\n                            icon = '<i style=\"color:#e6b800;\" class=\"fa fa-exclamation-triangle\" aria-hidden=\"true\"></i>';\n                            extra = `<div style=\"margin-top:6px;padding:6px 8px;background:#fff3cd;border-radius:5px;color:#856404;\n                            font-size:0.88em;font-weight:bold;\">\n                                <i class='fa fa-exclamation-circle' style='margin-right:4px;'></i> This PDF is not tagged. \n                                We are unable to check the accessibility of this topic..\n                            </div>`;\n                        }\n                        return `\n    <div style=\"display:flex;align-items:flex-start;margin-top:8px;margin-bottom:10px;\n        background:${bg};\n        border-radius:6px;padding:6px 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);opacity:${opacity};\">\n        <span style=\"font-size:1.2em;margin-right:8px;margin-top:2px;color:${color};\">\n            ${icon}\n        </span>\n        <div style=\"flex:1;\">\n            <div style=\"display:flex;align-items:center;justify-content:space-between;\">\n                <div style=\"font-weight:bold; font-size: 0.925rem; color: #1e1e1e;\">${c.label} ${infoIcon}</div>\n                ${(!c.pass && c.value !== 'PDF not tagged' && c.value !== 'Non applicable') ? `\n                    <button type=\"button\"\n                        aria-expanded=\"false\"\n                        aria-controls=\"fail-detail-${i}-${idx}\"\n                        style=\"background:none;border:none;cursor:pointer;padding:0 6px;\"\n                        onclick=\"\n                            var d=document.getElementById('fail-detail-${i}-${idx}');\n                            var a=this.querySelector('.arrow');\n                            var expanded=this.getAttribute('aria-expanded')==='true';\n                            d.style.display=expanded?'none':'block';\n                            this.setAttribute('aria-expanded',!expanded);\n                            a.style.transform=expanded?'rotate(0deg)':'rotate(90deg)';\n                        \">\n                        <span class=\"arrow\" style=\"display:inline-block;transition:transform 0.2s;\n                        vertical-align:middle;\">&#9662;</span>\n                    </button>\n                ` : ''}\n            </div>\n            <div style=\"font-size: 0.9rem; color: #282828; margin-left: 1%; margin-top: 1px;\">${c.value}</div>\n            ${infoDesc}\n            ${(!c.pass && c.value !== 'PDF not tagged' && c.value !== 'Non applicable') ? `\n            <div id=\"fail-detail-${i}-${idx}\" style=\"display:none;margin-top:5px;font-size:0.85em;color:#a94442;\">\n                <a href=\"${c.link}\" target=\"_blank\" rel=\"noopener\">${c.linkText || c.link}</a>\n            </div>\n        ` : ''}\n            ${extra}\n        </div>\n    </div>\n                        `;\n                    }).join('')}\n                        </div>\n                    </div>\n                </div>\n                        `;\n                    });\n                    div.innerHTML = html;\n                                        // Event delegation para info icons (garante funcionamento mesmo após re-render)\n                                        div.querySelectorAll('.pdf-info-icon').forEach(function(icon) {\n                                            icon.addEventListener('click', function(e) {\n                                                console.log('Info icon clicked', this, this.getAttribute('data-info-id'));\n                                                e.stopPropagation();\n                                                const id = this.getAttribute('data-info-id');\n                                                if (id) {\n                                                    const desc = document.getElementById(id);\n                                                    if (desc) {\n                                                        desc.style.display = (desc.style.display === 'block') ? 'none' : 'block';\n                                                    } else {\n                                                        console.warn('Descrição não encontrada para', id);\n                                                    }\n                                                }\n                                            });\n                                            // Remove inline onclick se existir (por segurança)\n                                            icon.removeAttribute('onclick');\n                                        });\n                    return true;\n                })\n                .catch(error => {\n                    const div = document.getElementById('analyzer-result');\n                    if (div) {\n                        div.innerHTML = `<span style=\"color:red\">Erro de rede ou servidor ao analisar PDF.</span>`;\n                    }\n                    console.error('Erro ao analisar PDF:', error);\n                    return null;\n                });\n            };\n\n            const observer = new MutationObserver(() => {\n                const draftid = getDraftId();\n                const div = document.getElementById('analyzer-result');\n                if (div) {\n                    div.innerHTML = '<span style=\"color:#555;\">Analyzing PDF accessibility, please wait...</span>';\n                }\n                if (draftid) {\n                    fetchPdfInfo(draftid);\n                }\n            });\n\n            observer.observe(filemanagerList, {\n                childList: true,\n                subtree: true\n            });\n        }\n    };\n});"],"names":["define","init","sesskey","M","cfg","filemanagerList","document","querySelector","console","warn","fetchPdfInfo","draftid","courseid","courseIdFromUrl","URLSearchParams","window","location","search","get","parseInt","bodyElement","body","courseIdFromBody","getAttribute","courseId","courseLink","match","href","getCurrentCourseId","fetch","method","headers","JSON","stringify","then","res","json","data","div","getElementById","status","pdfs","Array","isArray","length","innerHTML","message","testConfig","html","forEach","pdf","idx","filename","summary","excludedKeys","checks","Object","keys","filter","key","includes","map","config","find","value","testKey","testValue","label","pass","raw","link","linkText","description","passed","c","nonApplicable","failed","sort","a","b","getPriority","check","i","bg","icon","color","opacity","extra","infoId","replace","infoIcon","infoDesc","join","querySelectorAll","addEventListener","e","log","this","stopPropagation","id","desc","style","display","removeAttribute","catch","error","MutationObserver","_document$getElementB","observe","childList","subtree"],"mappings":"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"}